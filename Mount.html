<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Mount</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 4000,
    height: 2300,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 600 },
            debug: false
        }
    },
    input: {gamepad:true},
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

//Personnage
var player; 
var playerHp = 3;   //Hp du joueur
var jumpTick = 0;   //Timer pour le wall Jump
var boot = false    //botte récuperé ou non
var attack = false; //Joueur en train d'attaquer ou non
var invulnerable = false;   //Joueur invulnérable ou non
var playerInput = 5;    //Input du joueur
var sol = 0; //Sol sur lequel le joueur se trouve
var jumps = 1;  //Nombre de saut possible une fois en l'air
var jumping = true; //Sert a savoir si le joueur a le droit de sauter
    
//Group des différentes plateforms
var platforms;
var ice_platforms;
var snow_platforms;
var timerControl = 540;
//Control
var cursors;    //Keyboard key
var keyZ;       //Nom donné à la touche Z du clavier


var xAxis = 0;  //Stick xAxys
var yAxis = 0;  //Stick xAxys

var bottes; //Power-up récupérable
var gameOver = false;
var control;
    
var ennemies; //group d'ennemies

//Les différents ennemies
var ennemi1;
var ennemi2;
var ennemi3;
var ennemi4;
var ennemi5;
var ennemi6;



var game = new Phaser.Game(config);


//if (Phaser.Input.Keyboard.JustDown(space)){taFunction}
    
function preload ()
{
    this.load.image('bottes', 'assets/bottes.png');
    this.load.image('sky', 'assets/sky.png');
    this.load.image('left_rock', 'assets/left_rock.png');
    this.load.image('right_rock', 'assets/right_rock.png');
    this.load.image('bottom_ice', 'assets/bottom_ice.png');
    this.load.image('left_rock', 'assets/left_rock.png');
    this.load.image('bottom_left_rock', 'assets/bottom_left_rock.png');
    this.load.image('bottom_right_snow', 'assets/bottom_right_snow.png');
    this.load.image('bottom_right_snow2', 'assets/bottom_right_snow2.png');
    this.load.image('right_snow', 'assets/right_snow.png');
    this.load.image('middle_fondrock', 'assets/middle_fondrock.png');
    this.load.image('middle_rock_1', 'assets/middle_rock_1.png');
    this.load.image('middle_rock_2', 'assets/middle_rock_2.png');
    this.load.image('middle_rock_3', 'assets/middle_rock_3.png');
    this.load.image('mountainF', 'assets/mountain_far.png');
    this.load.image('mountainC', 'assets/mountain_close.png');
    this.load.image('snow', 'assets/snow_platform.png');
    this.load.image('icicle', 'assets/icicle.png');
    this.load.image('hp0', 'assets/hp_0.png');
    this.load.image('hp1', 'assets/hp_1.png');
    this.load.image('hp2', 'assets/hp_2.png');
    this.load.image('hp3', 'assets/hp_3.png');
    this.load.image('sword', 'assets/no_background.png');
    this.load.image('control', 'assets/control.png')
    this.load.atlas('ennemi', 'assets/ennemi.png', 'assets/ennemi.json');
    this.load.atlas('character', 'assets/character.png', 'assets/character.json');
    
}

function create ()
{
    
    
    keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);
    this.add.image(1445, 810,'sky').setScrollFactor(0.1);   
    this.add.image(1045, 810,'mountainF').setScrollFactor(0.1); //Deux plan de montagnes, parallax avec le setSCrollFactor.
    this.add.image(1245, 810,'mountainC').setScrollFactor(0.15);
    this.add.image(1500, 2300-813, 'middle_fondrock');  //Fond de la montagne du milieu
    
    
    //Création des groupes de plateforms
    platforms = this.physics.add.staticGroup();
    ice_platforms = this.physics.add.staticGroup();
    snow_platforms = this.physics.add.staticGroup({
    });
    
    bottes = this.physics.add.sprite(3700, 2050,'bottes');  //Création du power-up récupérable
    bottes.body.setAllowGravity(false);
    
    //Le personnage et ses caractéristiques
    player = this.physics.add.sprite(300, 2200, 'character');
    player.setSize(128, 163);
    player.setOffset(130, -90);
    player.setOrigin(0.5, 1);
    player.setCollideWorldBounds(true);
    
    player.on('animationcomplete', function(){ //  Autorise le personnage à bouger uniquement quand l'animation d'attaque se fini
        attack = false;
    });

    
    //Création des stalatites de glace
    var icicles = this.physics.add.group();
    icicle = icicles.create(3200, 1800, 'icicle').body.setAllowGravity(false);
    icicle1 = icicles.create(3000, 1750, 'icicle').body.setAllowGravity(false);
    
    
    
    
    //Création de la hitbox de l'attaque
    hitboxes = this.physics.add.sprite(0,0,'sword');
    hitboxes.body.setAllowGravity(false);
    
    //Animation du personage
    
    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'idle',
            start: 1,
            end: 6,
            zeroPad: 1
        }),
        frameRate: 5,
        repeat: -1
    });
    
     this.anims.create({
        key: 'run',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'run',
            start: 1,
            end: 10,
            zeroPad: 1
        }),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'walk',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'run',
            start: 1,
            end: 10,
            zeroPad: 1
        }),
        frameRate: 5,
        repeat: -1
    });
    
    this.anims.create({
        key: 'ascend',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'jump',
            start: 1,
            end: 2,
            zeroPad: 1
        }),
        frameRate: 1
    });
    
    this.anims.create({
        key: 'descend',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'jump',
            start: 3,
            end: 4,
            zeroPad: 1
        }),
        frameRate: 1
    });
    
    this.anims.create({
        key: 'attack',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'attack',
            start: 1,
            end: 6,
            zeroPad: 1
        }),
        frameRate: 10,
        repeat: 0
        
    });

    this.anims.create({
        key: 'wall',
        frames: this.anims.generateFrameNames('character', {
            prefix: 'wall',
            start: 1,
            end: 1,
            zeroPad: 1
        }),
        repeat: -1
        
    });
    
    
    //Animation des ennemis
    
    this.anims.create({
        key: 'ennemi_run',
        frames: this.anims.generateFrameNames('ennemi', {
            prefix: 'run',
            start: 1,
            end: 10,
            zeroPad: 1
        }),
        frameRate: 10,
        repeat: -1
    });
    
    this.anims.create({
        key: 'ennemi_walk',
        frames: this.anims.generateFrameNames('ennemi', {
            prefix: 'run',
            start: 1,
            end: 10,
            zeroPad: 1
        }),
        frameRate: 5,
        repeat: -1
    });

    
    //Création des contrôles clavier
    cursors = this.input.keyboard.createCursorKeys();
    
    
    //Création du groupe d'enenmi
    ennemies = this.physics.add.group();
    
    
    //Création des ennemis et de leur position
    ennemi1 = ennemies.create(2500, 2100, 'ennemi');
    
    ennemi2 = ennemies.create(1000, 1350, 'ennemi');
    ennemi2.flipX = true;
    
    ennemi3 = ennemies.create(1800, 1350, 'ennemi');
    ennemi4 = ennemies.create(1400, 500, 'ennemi');
    ennemi4.flipX = true;
    
    ennemi5 = ennemies.create(3000, 450, 'ennemi');
    ennemi5.flipX = true;
    
    ennemi6 = ennemies.create(3000, 2100, 'ennemi');
    ennemi6.flipX = true;
    
    //Pattern des ennemis
    var ennemy = this.tweens.add({
        targets: ennemi1,
        x: 2000,
        ease: 'Linear',
        duration: 1500,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi1.anims.play('ennemi_run')},
    })

    var ennemy = this.tweens.add({
        targets: ennemi2,
        x: 1800,
        ease: 'Linear',
        duration: 2000,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi2.anims.play('ennemi_run')},
    })
    
    var ennemy = this.tweens.add({
        targets: ennemi3,
        x: 1000,
        ease: 'Linear',
        duration: 2000,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi3.anims.play('ennemi_run')},
    })
    
    var ennemy = this.tweens.add({
        targets: ennemi4,
        x: 1700,
        ease: 'Linear',
        duration: 1000,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi4.anims.play('ennemi_run')},
    })
    
    var ennemy = this.tweens.add({
        targets: ennemi5,
        x: 3700,
        ease: 'Linear',
        duration: 5000,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi5.anims.play('ennemi_run')},
    })
    
    var ennemy = this.tweens.add({
        targets: ennemi6,
        x: 3700,
        ease: 'Linear',
        duration: 5000,
        yoyo: true,
        flipX: true,
        repeat: -1,
        onStart: function() {ennemi6.anims.play('ennemi_run')},
    })
    
    
    //Création des plateforms avec leur position et leur taille
    ice_platforms.create(1980, 2259, 'bottom_ice');
    platforms.create(77, 1915, 'left_rock').setOffset(-20,0);
    platforms.create(728, 2256, 'bottom_left_rock').setOffset(0,20);
    snow_platforms.create(3349, 2244, 'bottom_right_snow2').setOffset(0,30);
    snow_platforms.create(3928, 2030, 'bottom_right_snow').setSize(144, 700).setOffset(30,-50);
    snow_platforms.create(3366, 1138, 'right_snow').setSize(1266, 1200).setOffset(75,60);
    platforms.create(980, 884, 'middle_rock_1').setSize(160,515).setOffset(30, 15);
    platforms.create(1585, 867, 'middle_rock_2').setSize(540,520).setOffset(30, 30);
    platforms.create(1453, 1625, 'middle_rock_3').setSize(1135, 375).setOffset(20, 25);
    
    
    //Ajout de la touche X du clavier
    var keyX = this.input.keyboard.addKey('x');
    
    
    
    //Collider et Overlap
    this.physics.add.collider(player, ice_platforms, touching_ice, null, this);
    this.physics.add.collider(player, snow_platforms, touching_snow, null, this);
    this.physics.add.collider(player, platforms, touching_ground, null, this);
    this.physics.add.overlap(player, icicles, instaKill, null, this);
    this.physics.add.overlap(player, ennemies, hitEnnemi, null, this);
    this.physics.add.overlap(player, bottes, recolteBottes, null, this);
    this.physics.add.collider(bottes, snow_platforms);
    this.physics.add.collider(ennemies, platforms);
    this.physics.add.collider(ennemies, snow_platforms);
    this.physics.add.collider(ennemies, ice_platforms);


    this.physics.add.overlap(hitboxes, ennemies, attackEnnemi, null, this);
    this.physics.add.overlap(icicles, ennemies, killEnnemi, null, this);
    
    this.cameras.main.setBounds(0,0,4000, 2300);
    this.cameras.main.setSize(1920,1080);
    this.cameras.main.startFollow(player, true, 0.08, 0.08);
    
    control = this.add.image(950, 1600, 'control').setAlpha(0.8);
    //Création des hp, à la fin pour qu'elle soit au dessus de tout in-game
    hp = this.add.image(200, 100, 'hp3').setScrollFactor(0); //hp du joueur en haut a gauche, ScrollFactor à 0 pour que ça reste dans l'écran du joueur
}

function update ()
{
    if (gameOver)
    {
        return;
    }
    
    if (timerControl > 0);
    timerControl--;
    
    //Creation de la reconnaissance des pad
    let pad = Phaser.Input.Gamepad.Gamepad;
    
    
    if(this.input.gamepad.total){   //Si une manette est connecté
        pad = this.input.gamepad.getPad(0)  //pad récupère les inputs du joueur
        xAxis = pad ? pad.axes[0].getValue() : 0;   //Si le stick est utilisé xAxys récupère la valeur sur l'axe X, sinon il est égale a 0
        yAxis = pad ? pad.axes[1].getValue() : 0;   //Pareil pour l'axe Y
    }

    //Player's input
    //Les controles sont pensé comme un pavé numérique, le 5 représente l'absence d'input et les 8 autres chiffres sont les 8 directions, exception pour 2 qui deviens l'attaque
    
    if (keyZ.isDown || pad.X){  //Si Z ou X sur une manette est appuyé
        playerInput = 2;
        attack = true;
    }
    
    else if(jumpTick > 0){  //Utilisation de jumpTick comme timer, tant que c'est > 0 le joueur est forcé de ne rien faire
        playerInput = 5
        jumpTick--
        
    }
    //Haut droite
    else if (cursors.up.isDown && cursors.right.isDown || pad.A && pad.right  || pad.A && xAxis > 0){   
        playerInput = 9;
    }
    
    //Haut gauche
    else if(cursors.up.isDown && cursors.left.isDown || pad.A && pad.left || pad.A && xAxis < 0){
        playerInput = 7;
    }
    
    //Haut
    else if(cursors.up.isDown || pad.A){
        playerInput = 8;
    }

    //Gauche
    else if (cursors.left.isDown || pad.left || xAxis < 0){
        playerInput = 4;
    }
    
    //Droite
    else if (cursors.right.isDown || pad.right || xAxis > 0){
        playerInput = 6;
    }

    //Neutre/Centre
    else{
        playerInput = 5;
    }

    
    
if (player.body.velocity.x > 300){
        player.flipX = true;
    }
    
    else if (player.body.velocity.x < -300){
        player.flipX = false;
    }
    
    
    
    //Character's movement

    //Attack
    if(attack){                     //Si l'animation d'attack est en cours
       player.setVelocityX(0);     //Pendant l'attaque le joueur ne se déplace plus horizontalement
    }


    //Wall jump
    else if (player.body.blocked.left && playerInput >= 7){ //Si le joueur est bloqué sur sa gauche et qu'il essaye de sauter
        jumpTick = 30;  //JumpTick sert de timer entre le wall jump et le moment ou le joueur peut controler la direction de son personnage
        player.setVelocityY(-550)   //Saute en diagonale
        player.setVelocityX(400)

    }

    else if (player.body.blocked.right && playerInput >= 7){    //Pareil qu'au dessus mais si le joueur a un mur sur sa droite
        jumpTick = 30;
        player.setVelocityY(-550)
        player.setVelocityX(-400)
    }


    //Jump
    else if (playerInput == 8)      //Si le joueur appuie sur haut
    {
        player.setVelocityX(0);     //Retire la vitesse horizontale avant de sauter
        
        if (jumping && jumps > 0 && sol >= 1 && !boot){  //Si il a relaché la touche et si il lui reste des sauts
            player.setVelocityY(-380);
            jumps--;    //Retire un de la variable qui correspond au nombre de saut encore disponible
            jumping = false;    //jumping deviens faux tant que la touche est enfoncé, le joueur ne peut plus sauté tant qu'il ne la relache pas
        }
        
        else if (jumping && jumps > 0){  //Si il a relaché la touche et si il lui reste des sauts
            player.setVelocityY(-550);
            jumps--;    //Retire un de la variable qui correspond au nombre de saut encore disponible
            jumping = false;    //jumping deviens faux tant que la touche est enfoncé, le joueur ne peut plus sauté tant qu'il ne la relache pas
        }
    }
    
    else if (playerInput == 9)  //Si le joueur appuie sur la diagonale Haut Droite
    {
        player.flipX = true;    //Flip deviens vrai pour que le joueur regarde à droite
        if (sol == 2 && !boot){                 //Si le joueur est sur de la neige et n'a pas les bottes
            player.setVelocityX(250);   //Saute moins haut que sur le sol normal
        }
        
        else {                          //Sinon le joueur saute normalement
            player.setVelocityX(500);
        }
        
        if (jumping && jumps > 0 && sol >= 1 && !boot){     //Si le joueur peut sauter, est sur un sol glace ou neige et n'a pas les bottes
            player.setVelocityY(-380);                      //Saut moins puissant
            jumps--;
            jumping = false;
        }
        
        else if (jumping && jumps > 0){     //Si le joueur peut sauter
            player.setVelocityY(-550);      //Saut normal
            jumps--;
            jumping = false;
        }
    }
    
    
    else if (playerInput == 7)
    {
        player.flipX = false;
        if (sol == 2 && !boot){
            player.setVelocityX(-250);
        }
        
        else {
            player.setVelocityX(-500);
        }
            
        if (jumping && jumps > 0 && sol >= 1 && !boot){
            player.setVelocityY(-380);
            jumps--;
            jumping = false;
        }
        
        else if (jumping && jumps > 0){
            player.setVelocityY(-550);
            jumps--;
            jumping = false;
        }
    }
    
    
    //Movement left/right
    else if (playerInput == 4){
        player.flipX = false;
        if (sol == 2 && !boot){
            player.setVelocityX(-250);
        }
        
        else if (sol == 1 && player.body.touching.down && !boot){
            player.setAccelerationX(-300);
        }
        
        else {
            player.setVelocityX(-500);
        }
        
    }

    else if (playerInput == 6){
        player.flipX = true;
        if (sol == 2 && !boot){
            player.setVelocityX(250);
        }
        
        else if (sol == 1 && player.body.touching.down && !boot){
            player.setAccelerationX(300);
        }

        else {
            player.setVelocityX(500);
        }
    }
    
    
    //No input from player
    else {
        if (sol == 1 && player.body.touching.down){
            if(player.body.velocity.x < 0){
                player.setAccelerationX(300);
            }
            
            else if(player.body.velocity.x > 0) {
                player.setAccelerationX(-300);
            }
            
            
            else {
                player.setVelocityX(0);
                player.setAccelerationX(0);
            }
        }
        
        else if (jumpTick > 0){
                
            }
        
        else {
            player.setVelocityX(0);
            player.setAccelerationX(0);
        }
    }
    
    if(playerInput < 7){
        jumping = true;
    }
    
    if (player.body.touching.down)
    {
        jumps = 1;
    }
    
    
    //Character's Animation
    //L'animation du personnage est basé sur sa velocité
    if (attack){
        player.anims.play('attack', true);
    }
    
    else if (player.body.touching.left && !player.body.touching.down || player.body.touching.right && !player.body.touching.down){
        player.anims.play('wall', true);
    }
    
    else if (player.body.velocity.y <= 0 && !player.body.touching.down){
        player.anims.play('ascend', true);
    }
    
    else if (player.body.velocity.y > 0){
        player.anims.play('descend', true);
    }
    
    else if (player.body.velocity.x > 0){
        
        if (sol == 2 && !boot){
            player.anims.play('walk', true);
        }
        
        else {
            player.anims.play('run', true);
        }
       
    }
    
    else if (player.body.velocity.x < 0){
        
        if (sol == 2 && !boot){
            player.anims.play('walk', true);
        }
        
        else {
            player.anims.play('run', true);
        }
        
    }
    
    else{
        player.anims.play('idle', true);
    }
    

    if (attack){    //reposition de la hitboxes quand le joueur attack
        hitboxes.y = player.y-player.height/2.5;
        if (player.flipX){
            hitboxes.x = player.x+hitboxes.width/2;
        }

        else{
            hitboxes.x = player.x-hitboxes.width/2;
        }
    }
    
    
    //Barre d'hp
    if(playerHp == 1)
    {
        hp.setTexture('hp1');
    }
    

    else if (playerHp == 2){
        hp.setTexture('hp2');
    }
    
    else if(playerHp == 3){
       hp.setTexture('hp3');
       }
    
    else{
        hp.setTexture('hp0');
        player.destroy();
        ennemi1.destroy();
        ennemi2.destroy();
        ennemi3.destroy();
        ennemi4.destroy();
        ennemi5.destroy();
        ennemi6.destroy();
        this.physics.pause();
        
        gameOver = true;

        perdu = this.time.addEvent({ delay: 10, callback: function(){alert('Perdu');}, callbackScope: this});
    }
    
    //Si le joueur quiite la zone de départ, ou reste trop longtemps dedans, l'image des controls est détruite
    if (player.x > 1200 || player.y < 1900|| timerControl === 0){
            control.destroy()
        }
    
    //Si le joueuer est a -150 pixels de la position d'un icicle, il tombe
    if (icicle.x-150 < player.x && player.y >2000){
        icicle.setAllowGravity(true);
    }
    
    if (icicle1.x-150 < player.x ){
        icicle1.setAllowGravity(true);
    }
    
}


function instaKill(player, icicles){
    playerHp = 0;
}


function hitEnnemi(player, ennemi)
{
    if(!invulnerable)   // Si le joueur n'est pas invulnerable
    {
        playerHp --;                    // Le joueur perd un pv
        invulnerable = true;            // Il deviens invulnerable
        
        if (playerHp > 0){  // Si le joueur est encore en vie après s'être pris le coup
            clignotement = this.time.addEvent({ delay: 200, repeat: 9, callback: function(){player.visible = !player.visible;}, callbackScope: this}); // Le joueur passe de visible a non visible toutes les 200ms 9 fois de suite
        }

        tempsInvulerable = this.time.addEvent({ delay: 2000, callback: function(){invulnerable = false;}, callbackScope: this});  // Le joueur n'est plus invulnerable après 2000ms
    }
    
}
  
function recolteBottes(player, bottes){
    boot = true;
    bottes.destroy();
}
    
function attackEnnemi(hitboxes, ennemi)
{
    if(attack){ 
        ennemi.destroy();
    }
}
    
function killEnnemi(icicles, ennemi)
{
    ennemi.destroy();

}
    
function touching_ground(player, platforms)
{
    sol = 0;
}    

function touching_ice(player, ice_platforms)
{
    sol = 1;
}
    
function touching_snow(player, snow_platforms)
{
    sol = 2;
}

</script>

</body>
</html>